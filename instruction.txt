# Djezzy POS - Change Log & Instructions

## 2026-01-03: Role-Based Access Control for Agent Commercial

### Issue Fixed
- Agent Commercial users could see admin-only features like:
  - "Ajouter une offre" button
  - "Gérer les utilisateurs" button
  - Edit/Delete buttons on offer cards
  - Toggle switches for offer active status
  - Wrong status displays (4 statuses instead of correct ones)

### Changes Made

#### 1. Dashboard (index.html)
- **Admin Dashboard**: Shows all 4 stat cards (Utilisateurs, Offres, Numeros, Contrats) + status bars + all quick links
- **Agent Dashboard**: Shows 3 stat cards (Mes Ventes, Offres, Numeros) + beautiful Chart.js charts:
  - Ma Performance: Line chart showing validated sales for last 7 days
  - Numeros Disponibles: Donut chart showing available vs distributed numbers
  - Top Offres Vendues: Horizontal bar chart showing top 5 offers sold

#### 2. Offers Page (offers.html)
- Hidden from Agent Commercial:
  - "Ajouter une offre" button
  - Toggle switches for active status
  - Edit/Delete buttons on offer cards
  - Create/Edit modal
  - Delete confirmation modal

#### 3. Status Simplification
- **Numbers**: Only show "Disponibles" and "Distribués" (was showing 4 statuses)
- **Contracts**: Only show "Validés" (was showing 4 statuses)

#### 4. Backend Enhancement (contracts/views.py)
- Enhanced `/api/contracts/my-stats/` endpoint to return:
  - `total`: Total contracts count
  - `today`: Contracts created today
  - `this_month`: Contracts this month
  - `revenue`: Total revenue from validated contracts
  - `by_offer`: Top 5 offers sold (for chart)
  - `daily_sales`: Last 7 days sales data (for chart)

### Technical Implementation
- Used Django template conditionals: `{% if user.role == 'admin' %}` to show/hide elements
- Added Chart.js CDN to base.html for beautiful charts
- User roles are defined in `backend/apps/accounts/models.py`:
  - 'admin' = Administrateur
  - 'agent' = Agent Commercial

### Files Modified
1. `backend/apps/contracts/views.py`
2. `backend/apps/dashboard/templates/dashboard/base.html`
3. `backend/apps/dashboard/templates/dashboard/index.html`
4. `backend/apps/dashboard/templates/dashboard/offers.html`

---

## 2026-01-03: Phone Numbers Page - Role-Based Access Control

### Issue Fixed
- Agent Commercial could change phone number statuses (should be admin only)

### Changes Made (phone_numbers.html)
- **Hidden from Agent Commercial**:
  - Bulk actions dropdown (select multiple + change status)
  - Checkbox column for selecting numbers
  - Actions column with status change dropdown
  - "Réservés" and "Bloqués" status tabs
- **Renamed**: "Attribués" → "Distribués" for consistency
- **Agent can only VIEW**: Numbers list with Tous/Disponibles/Distribués tabs

### Files Modified
1. `backend/apps/dashboard/templates/dashboard/phone_numbers.html`

---

## 2026-01-03: Replace NFC Decode API with Local Dart Decoder (Mobile App)

### Issue Fixed
- Mobile app was calling external API (`http://173.212.249.251:8005/decode`) to decode NFC datagroups
- This required network connection and had latency issues

### Changes Made

#### 1. Added DatagroupDecoder Class
- **New File**: `mobile/lib/services/datagroup_decoder.dart`
- Copied from `idcard_nfc` project with same decoding logic
- Provides offline decoding for all ID card NFC datagroups:
  - **DG2**: Face photo extraction (JPEG/JP2 image markers)
  - **DG7**: Signature image extraction
  - **DG11**: Personal data (names, birth date/place, NIN, blood type) with ISO-8859-6 Arabic encoding
  - **DG12**: Document data (daira, baladia, issue/expiry dates)

#### 2. Updated read_nfc_page.dart
- Replaced `_decodeOnServer()` with `_decodeLocally()`
- Removed `http` package import (no longer needed)
- Uses `DatagroupDecoder.decodeAll()` for local decoding
- Same data format as before - no changes to downstream code

### Benefits
- **Offline Support**: App now works without network for NFC decoding
- **Faster**: No network latency, instant decoding
- **More Reliable**: No external server dependency
- **Consistent**: Same decoding logic as `idcard_nfc` project

### Files Modified
1. `mobile/lib/services/datagroup_decoder.dart` (NEW)
2. `mobile/lib/idcard/read_nfc_page.dart`

---

## 2026-01-03: PDF Download for Agent Contract History

### Feature Added
- Agents can now download PDF contracts from their sales history (web dashboard and mobile)
- PDFs are generated on-demand if not already stored

### Changes Made

#### 1. Backend PDF Generator Service
- **New File**: `backend/apps/contracts/services/pdf_generator.py`
- Uses ReportLab library for PDF generation
- Matches mobile app's PDF design:
  - Header with Djezzy logo and contract number
  - Client info section with photo
  - Offer details section
  - Terms and conditions
  - Signature section
- Arabic text support via `arabic-reshaper` and `python-bidi`
- Arabic font: `Amiri-Regular.ttf` copied to `backend/static/fonts/`

#### 2. New API Endpoint
- **Endpoint**: `GET /api/contracts/{id}/pdf/`
- Generates PDF on-demand if not stored
- Optional `?regenerate=true` parameter to force regeneration
- Returns PDF file for download

#### 3. Updated Templates
- **my_sales.html**: Added PDF download button next to view button for each contract
- **contract_detail.html**: PDF download now always visible (not conditional)

### Dependencies Added (requirements.txt)
```
reportlab>=4.0.0
arabic-reshaper>=3.0.0
python-bidi>=0.4.2
```

### Files Modified
1. `backend/requirements.txt`
2. `backend/static/fonts/Amiri-Regular.ttf` (NEW)
3. `backend/apps/contracts/services/__init__.py` (NEW)
4. `backend/apps/contracts/services/pdf_generator.py` (NEW)
5. `backend/apps/contracts/views.py`
6. `backend/apps/dashboard/templates/dashboard/my_sales.html`
7. `backend/apps/dashboard/templates/dashboard/contract_detail.html`
