# Djezzy POS - Change Log & Instructions

## 2026-01-03: Fix Agent Dashboard Phone Numbers Stats Mismatch

### Issue Fixed
- Agent dashboard web showed wrong phone numbers count (20 total, 16 available)
- Mobile app showed correct counts per offer (18 + 16 + 40 = 74 available)

### Root Cause
- Django REST Framework pagination (`PAGE_SIZE = 20`) caused `/api/phone-numbers/` to return only first 20 numbers
- Agent dashboard was counting from that paginated result instead of all numbers

### Solution
- Changed agent dashboard to use `/api/offers/active/` endpoint (same as mobile app)
- Sum `available_count` and `distributed_count` from all active offers
- Added `distributed_count` field to OfferSerializer

### Files Modified
1. `backend/apps/offers/serializers.py` - Added `distributed_count` SerializerMethodField
2. `backend/apps/dashboard/templates/dashboard/index.html` - Changed API call and stats calculation

---

## 2026-01-03: README Documentation Update

### Changes Made
- Updated README.md with comprehensive project documentation:
  - Role-based access control (Admin vs Agent Commercial)
  - PDF generation and download features
  - NFC local decoding capabilities (DG2, DG7, DG11, DG12)
  - Web dashboard features for both user types
  - New API endpoints (`/api/contracts/{id}/pdf/`, `/api/contracts/my-stats/`)
  - Full tech stack with new dependencies
  - User roles and permissions documentation

### Files Modified
1. `README.md` (comprehensive update)
2. `.gitignore` (added idcard_nfc/ - separate project)

---

## 2026-01-03: Role-Based Access Control for Agent Commercial

### Issue Fixed
- Agent Commercial users could see admin-only features like:
  - "Ajouter une offre" button
  - "Gérer les utilisateurs" button
  - Edit/Delete buttons on offer cards
  - Toggle switches for offer active status
  - Wrong status displays (4 statuses instead of correct ones)

### Changes Made

#### 1. Dashboard (index.html)
- **Admin Dashboard**: Shows all 4 stat cards (Utilisateurs, Offres, Numeros, Contrats) + status bars + all quick links
- **Agent Dashboard**: Shows 3 stat cards (Mes Ventes, Offres, Numeros) + beautiful Chart.js charts:
  - Ma Performance: Line chart showing validated sales for last 7 days
  - Numeros Disponibles: Donut chart showing available vs distributed numbers
  - Top Offres Vendues: Horizontal bar chart showing top 5 offers sold

#### 2. Offers Page (offers.html)
- Hidden from Agent Commercial:
  - "Ajouter une offre" button
  - Toggle switches for active status
  - Edit/Delete buttons on offer cards
  - Create/Edit modal
  - Delete confirmation modal

#### 3. Status Simplification
- **Numbers**: Only show "Disponibles" and "Distribués" (was showing 4 statuses)
- **Contracts**: Only show "Validés" (was showing 4 statuses)

#### 4. Backend Enhancement (contracts/views.py)
- Enhanced `/api/contracts/my-stats/` endpoint to return:
  - `total`: Total contracts count
  - `today`: Contracts created today
  - `this_month`: Contracts this month
  - `revenue`: Total revenue from validated contracts
  - `by_offer`: Top 5 offers sold (for chart)
  - `daily_sales`: Last 7 days sales data (for chart)

### Technical Implementation
- Used Django template conditionals: `{% if user.role == 'admin' %}` to show/hide elements
- Added Chart.js CDN to base.html for beautiful charts
- User roles are defined in `backend/apps/accounts/models.py`:
  - 'admin' = Administrateur
  - 'agent' = Agent Commercial

### Files Modified
1. `backend/apps/contracts/views.py`
2. `backend/apps/dashboard/templates/dashboard/base.html`
3. `backend/apps/dashboard/templates/dashboard/index.html`
4. `backend/apps/dashboard/templates/dashboard/offers.html`

---

## 2026-01-03: Phone Numbers Page - Role-Based Access Control

### Issue Fixed
- Agent Commercial could change phone number statuses (should be admin only)

### Changes Made (phone_numbers.html)
- **Hidden from Agent Commercial**:
  - Bulk actions dropdown (select multiple + change status)
  - Checkbox column for selecting numbers
  - Actions column with status change dropdown
  - "Réservés" and "Bloqués" status tabs
- **Renamed**: "Attribués" → "Distribués" for consistency
- **Agent can only VIEW**: Numbers list with Tous/Disponibles/Distribués tabs

### Files Modified
1. `backend/apps/dashboard/templates/dashboard/phone_numbers.html`

---

## 2026-01-03: Replace NFC Decode API with Local Dart Decoder (Mobile App)

### Issue Fixed
- Mobile app was calling external API (`http://173.212.249.251:8005/decode`) to decode NFC datagroups
- This required network connection and had latency issues

### Changes Made

#### 1. Added DatagroupDecoder Class
- **New File**: `mobile/lib/services/datagroup_decoder.dart`
- Copied from `idcard_nfc` project with same decoding logic
- Provides offline decoding for all ID card NFC datagroups:
  - **DG2**: Face photo extraction (JPEG/JP2 image markers)
  - **DG7**: Signature image extraction
  - **DG11**: Personal data (names, birth date/place, NIN, blood type) with ISO-8859-6 Arabic encoding
  - **DG12**: Document data (daira, baladia, issue/expiry dates)

#### 2. Updated read_nfc_page.dart
- Replaced `_decodeOnServer()` with `_decodeLocally()`
- Removed `http` package import (no longer needed)
- Uses `DatagroupDecoder.decodeAll()` for local decoding
- Same data format as before - no changes to downstream code

### Benefits
- **Offline Support**: App now works without network for NFC decoding
- **Faster**: No network latency, instant decoding
- **More Reliable**: No external server dependency
- **Consistent**: Same decoding logic as `idcard_nfc` project

### Files Modified
1. `mobile/lib/services/datagroup_decoder.dart` (NEW)
2. `mobile/lib/idcard/read_nfc_page.dart`

---

## 2026-01-03: PDF Download for Agent Contract History

### Feature Added
- Agents can now download PDF contracts from their sales history (web dashboard and mobile)
- PDFs are generated on-demand if not already stored

### Changes Made

#### 1. Backend PDF Generator Service
- **New File**: `backend/apps/contracts/services/pdf_generator.py`
- Uses ReportLab library for PDF generation
- Matches mobile app's PDF design:
  - Header with Djezzy logo and contract number
  - Client info section with photo
  - Offer details section
  - Terms and conditions
  - Signature section
- Arabic text support via `arabic-reshaper` and `python-bidi`
- Arabic font: `Amiri-Regular.ttf` copied to `backend/static/fonts/`

#### 2. New API Endpoint
- **Endpoint**: `GET /api/contracts/{id}/pdf/`
- Generates PDF on-demand if not stored
- Optional `?regenerate=true` parameter to force regeneration
- Returns PDF file for download

#### 3. Updated Templates
- **my_sales.html**: Added PDF download button next to view button for each contract
- **contract_detail.html**: PDF download now always visible (not conditional)

### Dependencies Added (requirements.txt)
```
reportlab>=4.0.0
arabic-reshaper>=3.0.0
python-bidi>=0.4.2
```

### Files Modified
1. `backend/requirements.txt`
2. `backend/static/fonts/Amiri-Regular.ttf` (NEW)
3. `backend/apps/contracts/services/__init__.py` (NEW)
4. `backend/apps/contracts/services/pdf_generator.py` (NEW)
5. `backend/apps/contracts/views.py`
6. `backend/apps/dashboard/templates/dashboard/my_sales.html`
7. `backend/apps/dashboard/templates/dashboard/contract_detail.html`

---

## 2026-01-03: PDF Download Bug Fixes

### Issues Fixed

#### 1. Web PDF 500 Error
- **Problem**: Downloading contract PDF via `/api/contracts/{id}/pdf/` returned 500 error
- **Root Cause**: `pdf_generator.py` used wrong field name `offer.data_amount` instead of `offer.data_allowance_mb`
- **Fix**: Changed line 314 to use correct field name and convert MB to GB:
  ```python
  ('Internet', f"{offer.data_allowance_mb // 1024} Go" if offer.data_allowance_mb else '-'),
  ```

#### 2. Mobile App Missing PDF Download
- **Problem**: Contract cards in "Mes Ventes" page had no PDF download button
- **Fix**: Added PDF download button to each contract card that opens the PDF in browser
- **Added**: `url_launcher` package for opening PDF URLs

### Files Modified
1. `backend/apps/contracts/services/pdf_generator.py` (line 314 fix)
2. `mobile/lib/sales/my_sales_page.dart` (added PDF button + _downloadPdf method)
3. `mobile/pubspec.yaml` (added url_launcher dependency)

---

## 2026-01-03: Mobile PDF Download Authentication & Backend PDF Quality

### Issues Fixed

#### 1. Mobile PDF Download 403 Error
- **Problem**: Opening PDF URL in browser (url_launcher) didn't pass auth token
- **Root Cause**: Browser doesn't have access to app's authentication token
- **Fix**: Download PDF with authenticated API call, save to temp file, open with PDF viewer
- **Added**: `open_filex` package for opening downloaded PDFs

#### 2. Backend PDF Quality - Cramped Single Page
- **Problem**: Backend PDF was cramped on 1 page, unlike mobile's 2-page well-formatted PDF
- **Root Cause**: Used ReportLab's low-level `canvas.Canvas` with fixed heights
- **Fix**: Complete rewrite using ReportLab's **Platypus** framework:
  - `SimpleDocTemplate` for automatic page handling
  - Flowable elements (Paragraph, Table, Spacer, Image)
  - Content flows naturally to multiple pages when needed
  - Added "Avantages inclus" section with bullet points
  - Better spacing between sections

### Files Modified
1. `backend/apps/contracts/services/pdf_generator.py` (complete rewrite with Platypus)
2. `mobile/lib/sales/my_sales_page.dart` (authenticated download + open_filex)
3. `mobile/pubspec.yaml` (added open_filex)
4. `mobile/android/settings.gradle.kts` (upgraded Android Gradle Plugin to 8.9.1)
