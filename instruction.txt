# Djezzy POS - Change Log & Instructions

## 2026-01-03: Show Available Numbers Count on Offers Page

### Feature Added
- Each offer card now displays "X numeros disponibles" (available numbers count)
- Matches the mobile app behavior
- Added missing `formatData` helper function

### Files Modified
1. `backend/apps/dashboard/templates/dashboard/offers.html`

---

## 2026-01-03: Fix Phone Numbers Page Pagination

### Issue Fixed
- Numeros page showed only 20 phone numbers (pagination limit)
- Tab counts were wrong: Tous (20), Disponibles (16), Distribues (4)
- Should show all 74+ phone numbers

### Solution
- Added custom pagination class `PhoneNumberPagination` that allows `?page_size=all`
- Updated phone_numbers.html to use `?page_size=all` parameter

### Files Modified
1. `backend/apps/phone_numbers/views.py` - Added PhoneNumberPagination class
2. `backend/apps/dashboard/templates/dashboard/phone_numbers.html` - Use page_size=all

---

## 2026-01-03: Fix Agent Dashboard Phone Numbers Stats Mismatch

### Issue Fixed
- Agent dashboard web showed wrong phone numbers count (20 total, 16 available)
- Mobile app showed correct counts per offer (18 + 16 + 40 = 74 available)

### Root Cause
- Django REST Framework pagination (`PAGE_SIZE = 20`) caused `/api/phone-numbers/` to return only first 20 numbers
- Agent dashboard was counting from that paginated result instead of all numbers

### Solution
- Changed agent dashboard to use `/api/offers/active/` endpoint (same as mobile app)
- Sum `available_count` and `distributed_count` from all active offers
- Added `distributed_count` field to OfferSerializer

### Files Modified
1. `backend/apps/offers/serializers.py` - Added `distributed_count` SerializerMethodField
2. `backend/apps/dashboard/templates/dashboard/index.html` - Changed API call and stats calculation

---

## 2026-01-03: README Documentation Update

### Changes Made
- Updated README.md with comprehensive project documentation:
  - Role-based access control (Admin vs Agent Commercial)
  - PDF generation and download features
  - NFC local decoding capabilities (DG2, DG7, DG11, DG12)
  - Web dashboard features for both user types
  - New API endpoints (`/api/contracts/{id}/pdf/`, `/api/contracts/my-stats/`)
  - Full tech stack with new dependencies
  - User roles and permissions documentation

### Files Modified
1. `README.md` (comprehensive update)
2. `.gitignore` (added idcard_nfc/ - separate project)

---

## 2026-01-03: Role-Based Access Control for Agent Commercial

### Issue Fixed
- Agent Commercial users could see admin-only features like:
  - "Ajouter une offre" button
  - "Gérer les utilisateurs" button
  - Edit/Delete buttons on offer cards
  - Toggle switches for offer active status
  - Wrong status displays (4 statuses instead of correct ones)

### Changes Made

#### 1. Dashboard (index.html)
- **Admin Dashboard**: Shows all 4 stat cards (Utilisateurs, Offres, Numeros, Contrats) + status bars + all quick links
- **Agent Dashboard**: Shows 3 stat cards (Mes Ventes, Offres, Numeros) + beautiful Chart.js charts:
  - Ma Performance: Line chart showing validated sales for last 7 days
  - Numeros Disponibles: Donut chart showing available vs distributed numbers
  - Top Offres Vendues: Horizontal bar chart showing top 5 offers sold

#### 2. Offers Page (offers.html)
- Hidden from Agent Commercial:
  - "Ajouter une offre" button
  - Toggle switches for active status
  - Edit/Delete buttons on offer cards
  - Create/Edit modal
  - Delete confirmation modal

#### 3. Status Simplification
- **Numbers**: Only show "Disponibles" and "Distribués" (was showing 4 statuses)
- **Contracts**: Only show "Validés" (was showing 4 statuses)

#### 4. Backend Enhancement (contracts/views.py)
- Enhanced `/api/contracts/my-stats/` endpoint to return:
  - `total`: Total contracts count
  - `today`: Contracts created today
  - `this_month`: Contracts this month
  - `revenue`: Total revenue from validated contracts
  - `by_offer`: Top 5 offers sold (for chart)
  - `daily_sales`: Last 7 days sales data (for chart)

### Technical Implementation
- Used Django template conditionals: `{% if user.role == 'admin' %}` to show/hide elements
- Added Chart.js CDN to base.html for beautiful charts
- User roles are defined in `backend/apps/accounts/models.py`:
  - 'admin' = Administrateur
  - 'agent' = Agent Commercial

### Files Modified
1. `backend/apps/contracts/views.py`
2. `backend/apps/dashboard/templates/dashboard/base.html`
3. `backend/apps/dashboard/templates/dashboard/index.html`
4. `backend/apps/dashboard/templates/dashboard/offers.html`

---

## 2026-01-03: Phone Numbers Page - Role-Based Access Control

### Issue Fixed
- Agent Commercial could change phone number statuses (should be admin only)

### Changes Made (phone_numbers.html)
- **Hidden from Agent Commercial**:
  - Bulk actions dropdown (select multiple + change status)
  - Checkbox column for selecting numbers
  - Actions column with status change dropdown
  - "Réservés" and "Bloqués" status tabs
- **Renamed**: "Attribués" → "Distribués" for consistency
- **Agent can only VIEW**: Numbers list with Tous/Disponibles/Distribués tabs

### Files Modified
1. `backend/apps/dashboard/templates/dashboard/phone_numbers.html`

---

## 2026-01-03: Replace NFC Decode API with Local Dart Decoder (Mobile App)

### Issue Fixed
- Mobile app was calling external API (`http://173.212.249.251:8005/decode`) to decode NFC datagroups
- This required network connection and had latency issues

### Changes Made

#### 1. Added DatagroupDecoder Class
- **New File**: `mobile/lib/services/datagroup_decoder.dart`
- Copied from `idcard_nfc` project with same decoding logic
- Provides offline decoding for all ID card NFC datagroups:
  - **DG2**: Face photo extraction (JPEG/JP2 image markers)
  - **DG7**: Signature image extraction
  - **DG11**: Personal data (names, birth date/place, NIN, blood type) with ISO-8859-6 Arabic encoding
  - **DG12**: Document data (daira, baladia, issue/expiry dates)

#### 2. Updated read_nfc_page.dart
- Replaced `_decodeOnServer()` with `_decodeLocally()`
- Removed `http` package import (no longer needed)
- Uses `DatagroupDecoder.decodeAll()` for local decoding
- Same data format as before - no changes to downstream code

### Benefits
- **Offline Support**: App now works without network for NFC decoding
- **Faster**: No network latency, instant decoding
- **More Reliable**: No external server dependency
- **Consistent**: Same decoding logic as `idcard_nfc` project

### Files Modified
1. `mobile/lib/services/datagroup_decoder.dart` (NEW)
2. `mobile/lib/idcard/read_nfc_page.dart`

---

## 2026-01-03: PDF Download for Agent Contract History

### Feature Added
- Agents can now download PDF contracts from their sales history (web dashboard and mobile)
- PDFs are generated on-demand if not already stored

### Changes Made

#### 1. Backend PDF Generator Service
- **New File**: `backend/apps/contracts/services/pdf_generator.py`
- Uses ReportLab library for PDF generation
- Matches mobile app's PDF design:
  - Header with Djezzy logo and contract number
  - Client info section with photo
  - Offer details section
  - Terms and conditions
  - Signature section
- Arabic text support via `arabic-reshaper` and `python-bidi`
- Arabic font: `Amiri-Regular.ttf` copied to `backend/static/fonts/`

#### 2. New API Endpoint
- **Endpoint**: `GET /api/contracts/{id}/pdf/`
- Generates PDF on-demand if not stored
- Optional `?regenerate=true` parameter to force regeneration
- Returns PDF file for download

#### 3. Updated Templates
- **my_sales.html**: Added PDF download button next to view button for each contract
- **contract_detail.html**: PDF download now always visible (not conditional)

### Dependencies Added (requirements.txt)
```
reportlab>=4.0.0
arabic-reshaper>=3.0.0
python-bidi>=0.4.2
```

### Files Modified
1. `backend/requirements.txt`
2. `backend/static/fonts/Amiri-Regular.ttf` (NEW)
3. `backend/apps/contracts/services/__init__.py` (NEW)
4. `backend/apps/contracts/services/pdf_generator.py` (NEW)
5. `backend/apps/contracts/views.py`
6. `backend/apps/dashboard/templates/dashboard/my_sales.html`
7. `backend/apps/dashboard/templates/dashboard/contract_detail.html`

---

## 2026-01-03: PDF Download Bug Fixes

### Issues Fixed

#### 1. Web PDF 500 Error
- **Problem**: Downloading contract PDF via `/api/contracts/{id}/pdf/` returned 500 error
- **Root Cause**: `pdf_generator.py` used wrong field name `offer.data_amount` instead of `offer.data_allowance_mb`
- **Fix**: Changed line 314 to use correct field name and convert MB to GB:
  ```python
  ('Internet', f"{offer.data_allowance_mb // 1024} Go" if offer.data_allowance_mb else '-'),
  ```

#### 2. Mobile App Missing PDF Download
- **Problem**: Contract cards in "Mes Ventes" page had no PDF download button
- **Fix**: Added PDF download button to each contract card that opens the PDF in browser
- **Added**: `url_launcher` package for opening PDF URLs

### Files Modified
1. `backend/apps/contracts/services/pdf_generator.py` (line 314 fix)
2. `mobile/lib/sales/my_sales_page.dart` (added PDF button + _downloadPdf method)
3. `mobile/pubspec.yaml` (added url_launcher dependency)

---

## 2026-01-03: Mobile PDF Download Authentication & Backend PDF Quality

### Issues Fixed

#### 1. Mobile PDF Download 403 Error
- **Problem**: Opening PDF URL in browser (url_launcher) didn't pass auth token
- **Root Cause**: Browser doesn't have access to app's authentication token
- **Fix**: Download PDF with authenticated API call, save to temp file, open with PDF viewer
- **Added**: `open_filex` package for opening downloaded PDFs

#### 2. Backend PDF Quality - Cramped Single Page
- **Problem**: Backend PDF was cramped on 1 page, unlike mobile's 2-page well-formatted PDF
- **Root Cause**: Used ReportLab's low-level `canvas.Canvas` with fixed heights
- **Fix**: Complete rewrite using ReportLab's **Platypus** framework:
  - `SimpleDocTemplate` for automatic page handling
  - Flowable elements (Paragraph, Table, Spacer, Image)
  - Content flows naturally to multiple pages when needed
  - Added "Avantages inclus" section with bullet points
  - Better spacing between sections

### Files Modified
1. `backend/apps/contracts/services/pdf_generator.py` (complete rewrite with Platypus)
2. `mobile/lib/sales/my_sales_page.dart` (authenticated download + open_filex)
3. `mobile/pubspec.yaml` (added open_filex)
4. `mobile/android/settings.gradle.kts` (upgraded Android Gradle Plugin to 8.9.1)

---

## 2026-01-07: Sync Backend PDF with Mobile App PDF

### Issue Fixed
- PDF downloaded from history (mobile app or web dashboard) didn't match the PDF shown in mobile app after signing
- Missing fields: Arabic birth place, Blood type, Phone, Email, Address

### Root Causes
1. **Missing fields in backend model**: `customer_birth_place_ar` and `customer_blood_type` were collected from ID card but not stored in database
2. **PDF caching**: Backend was caching PDFs and not regenerating them when contract data was updated

### Changes Made

#### 1. Added Missing Fields to Contract Model
- `customer_birth_place_ar` (CharField, max_length=200, blank=True)
- `customer_blood_type` (CharField, max_length=10, blank=True)

#### 2. Updated Serializers
- Added `customer_birth_place_ar` and `customer_blood_type` to both `ContractSerializer` and `ContractCreateSerializer`

#### 3. Updated Mobile API Service
- Now sends `customer_birth_place_ar` from `personal['birthPlaceAr']`
- Now sends `customer_blood_type` from `personal['bloodType']`

#### 4. Updated Backend PDF Generator
- Added `Lieu (Arabe)` field after birth place (with Arabic font support)
- Added `Groupe sanguin` field after sex

#### 5. Fixed PDF Caching
- Changed PDF download endpoint to ALWAYS regenerate PDF
- Ensures downloaded PDF always has latest contract data

### Files Modified
1. `backend/apps/contracts/models.py` - Added 2 new fields
2. `backend/apps/contracts/migrations/0004_contract_customer_birth_place_ar_and_more.py` - New migration
3. `backend/apps/contracts/serializers.py` - Added fields to serializers
4. `backend/apps/contracts/services/pdf_generator.py` - Added Arabic birth place + blood type rows
5. `backend/apps/contracts/views.py` - Always regenerate PDF on download
6. `mobile/lib/services/api_service.dart` - Send new fields to backend

---

## 2026-01-07: Add QR Code to Contract PDFs

### Feature Added
- Each contract PDF now has a unique QR code in the signature section
- When scanned, the QR code directly downloads the contract PDF
- Public access - no authentication required

### Implementation Details

#### 1. Public PDF Download Endpoint
- **Endpoint:** `GET /api/contracts/public/{contract_number}/pdf/`
- **Permission:** AllowAny (no authentication)
- **Response:** PDF file download (inline)

#### 2. Backend QR Code Generation
- Added `qrcode[pil]>=7.0` library to requirements.txt
- QR code generated in `_generate_qr_code()` method
- URL format: `https://pos.djezzy.dz/api/contracts/public/{contract_number}/pdf/`
- QR code size: 60x60px
- Placed in signature section (bottom right)

#### 3. Mobile QR Code Generation
- Uses built-in `pw.BarcodeWidget` from pdf package
- Same URL format as backend
- Same placement in signature section

### QR Code Design
```
┌─────────────────────────────────────────────────┐
│  SIGNATURE DU CLIENT                            │
│  ┌──────────┐                           ┌────┐  │
│  │ [Sign]   │  Customer Name            │ QR │  │
│  │          │  Date: XX/XX/XXXX         │CODE│  │
│  └──────────┘  ✓ Confirmed              └────┘  │
│                                 Scanner pour    │
│                                 telecharger     │
└─────────────────────────────────────────────────┘
```

### Files Modified
1. `backend/requirements.txt` - Added qrcode[pil]
2. `backend/apps/contracts/urls.py` - Added public PDF route
3. `backend/apps/contracts/views.py` - Added public_contract_pdf view
4. `backend/apps/contracts/services/pdf_generator.py` - Added QR code generation
5. `mobile/lib/services/pdf_generator_service.dart` - Added QR code to PDF

---

## 2026-01-07: Single PDF Generator + QR Code Contract ID Fix

### Architecture Change: Single PDF Generator
- **Before:** Two PDF generators - mobile and backend generated different PDFs
- **After:** Only mobile generates PDF, sends it to backend for storage
- Backend now saves mobile-generated PDF instead of regenerating
- Ensures 100% consistency between preview and download

### QR Code 404 Bug Fix
- **Problem:** QR code returned 404 "No Contract matches the given query"
- **Root Cause:** Mobile generated contract ID (e.g., `DJ-20260107-687953`) used in QR URL, but backend generated a DIFFERENT contract number when saving
- **Fix:** Mobile now sends its contract ID to backend, backend uses it instead of generating new one

### Changes Made

#### 1. Mobile API Service (api_service.dart)
- Added `contractId` parameter to `submitContract()` method
- Sends `contract_number` in request body

#### 2. Contract Preview Page (contract_preview_page.dart)
- Passes `widget.contractData.contractId` to API call

#### 3. Backend Serializer (serializers.py)
- Added `contract_number` to fields list
- Uses client-provided value instead of auto-generating

#### 4. Backend Model (models.py)
- `save()` already had correct logic: only generates if no contract_number provided
```python
def save(self, *args, **kwargs):
    if not self.contract_number:
        self.contract_number = self.generate_contract_number()
    super().save(*args, **kwargs)
```

### Files Modified
1. `mobile/lib/services/api_service.dart`
2. `mobile/lib/contract/contract_preview_page.dart`
3. `backend/apps/contracts/serializers.py`

---

## 2026-01-07: Separate Contact Info from Signature Screen

### Change Summary
Split the signature screen into two separate screens:
1. **ContactInfoPage** - for entering phone, email, and address
2. **SignaturePage** - for signature only

### New Flow
```
MRZ Scan -> Contact Info Page -> Signature Page -> Contract Preview
```

### Changes Made

#### 1. New File: `mobile/lib/contract/contact_info_page.dart`
- User info summary header (photo, name, CNI, NIN)
- Phone field (TextInputType.phone)
- Email field (TextInputType.emailAddress)
- Address field (TextInputType.streetAddress, multiline)
- "Suivant" button to navigate to SignaturePage
- Contact fields remain optional

#### 2. Modified: `mobile/lib/contract/signature_page.dart`
- Removed contact info section (phone, email, address fields)
- Removed contact form controllers
- Now receives contact info already in ContractData from ContactInfoPage
- Kept: User info header, signature canvas, confirmation checkbox, submit button

#### 3. Modified: `mobile/lib/idcard/read_nfc_page.dart`
- Changed navigation target from SignaturePage to ContactInfoPage
- Updated import statement

### Files Modified
1. `mobile/lib/contract/contact_info_page.dart` (NEW)
2. `mobile/lib/contract/signature_page.dart`
3. `mobile/lib/idcard/read_nfc_page.dart`

---

## 2026-01-07: Add OTP Verification Screen for Agent Role (Demo)

### Feature Added
- OTP verification screen appears after login for users with "agent" role
- Demo mode: accepts any 6-digit code
- Admin users bypass OTP and go directly to dashboard
- Implemented in both web dashboard and mobile app

### Login Flow Changes

#### Mobile App
```
LoginPage -> (check role) -> OtpPage (agents) -> OfferSelectionPage
                          -> OfferSelectionPage (admins)
```

#### Web Dashboard
```
/dashboard/login/ -> (check role) -> /dashboard/otp/ (agents) -> /dashboard/
                                  -> /dashboard/ (admins)
```

### Changes Made

#### 1. Mobile OTP Page
**New File:** `mobile/lib/auth/otp_page.dart`
- 6-digit OTP input with individual boxes
- "Verifier" button (accepts any code)
- "Renvoyer" link (shows snackbar message)
- Djezzy red theme styling

#### 2. Mobile Login Page
**Modified:** `mobile/lib/auth/login_page.dart`
- After successful login, checks `userData['role']`
- Agents navigate to OtpPage
- Admins navigate directly to OfferSelectionPage

#### 3. Web OTP Template
**New File:** `backend/apps/dashboard/templates/dashboard/otp.html`
- 6-digit OTP input using Alpine.js
- Auto-focus next input on digit entry
- Paste support for full OTP code
- "Renvoyer" link with success message
- Tailwind CSS styling matching login.html

#### 4. Backend OTP View
**Modified:** `backend/apps/dashboard/views.py`
- Added `otp_view()` function:
  - GET: renders OTP template
  - POST: accepts any 6-digit code, sets session['otp_verified'] = True
  - Handles resend request (shows success message)
- Updated `login_view()`:
  - After login, redirects agents to OTP page
  - Admins go directly to dashboard
- Updated `logout_view()`:
  - Clears `otp_verified` session on logout
- Updated `index_view()`:
  - Redirects agents to OTP if not verified

#### 5. URL Route
**Modified:** `backend/apps/dashboard/urls.py`
- Added: `path('otp/', views.otp_view, name='otp')`

### Files Modified
1. `mobile/lib/auth/otp_page.dart` (NEW)
2. `mobile/lib/auth/login_page.dart`
3. `backend/apps/dashboard/templates/dashboard/otp.html` (NEW)
4. `backend/apps/dashboard/views.py`
5. `backend/apps/dashboard/urls.py`

---

## 2026-01-07: Increase Signature Pad Size for Better UX

### Change Made
- Increased signature canvas height from 200px to 280px
- Provides more comfortable space for handwriting signatures

### File Modified
1. `mobile/lib/contract/signature_page.dart` - Line 243
