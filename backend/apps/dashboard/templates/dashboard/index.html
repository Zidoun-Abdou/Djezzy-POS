{% extends 'dashboard/base.html' %}

{% block title %}Tableau de bord - Djezzy POS{% endblock %}

{% block content %}
{% if user.role == 'admin' %}
<!-- ==================== ADMIN DASHBOARD ==================== -->
<div x-data="adminDashboard()" x-init="fetchStats()">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Users Card -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Utilisateurs</p>
                    <template x-if="loading">
                        <div class="h-8 w-16 bg-gray-200 rounded animate-pulse mt-1"></div>
                    </template>
                    <template x-if="!loading">
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.users.total"></p>
                    </template>
                </div>
            </div>
            <div class="mt-4 flex space-x-4 text-xs text-gray-500" x-show="!loading">
                <span><span class="font-medium text-gray-700" x-text="stats.users.agents"></span> Agents</span>
                <span><span class="font-medium text-gray-700" x-text="stats.users.managers"></span> Managers</span>
            </div>
        </div>

        <!-- Offers Card -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-djezzy/10 text-djezzy">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Offres</p>
                    <template x-if="loading">
                        <div class="h-8 w-16 bg-gray-200 rounded animate-pulse mt-1"></div>
                    </template>
                    <template x-if="!loading">
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.offers.total"></p>
                    </template>
                </div>
            </div>
            <div class="mt-4 flex space-x-4 text-xs text-gray-500" x-show="!loading">
                <span><span class="font-medium text-green-600" x-text="stats.offers.active"></span> Actives</span>
            </div>
        </div>

        <!-- Phone Numbers Card -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Numeros</p>
                    <template x-if="loading">
                        <div class="h-8 w-16 bg-gray-200 rounded animate-pulse mt-1"></div>
                    </template>
                    <template x-if="!loading">
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.phones.total"></p>
                    </template>
                </div>
            </div>
            <div class="mt-4 flex space-x-4 text-xs text-gray-500" x-show="!loading">
                <span><span class="font-medium text-green-600" x-text="stats.phones.available"></span> Disponibles</span>
                <span><span class="font-medium text-blue-600" x-text="stats.phones.distributed"></span> Distribues</span>
            </div>
        </div>

        <!-- Contracts Card -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Contrats</p>
                    <template x-if="loading">
                        <div class="h-8 w-16 bg-gray-200 rounded animate-pulse mt-1"></div>
                    </template>
                    <template x-if="!loading">
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.contracts.total"></p>
                    </template>
                </div>
            </div>
            <div class="mt-4 flex space-x-4 text-xs text-gray-500" x-show="!loading">
                <span><span class="font-medium text-green-600" x-text="stats.contracts.validated"></span> Valides</span>
            </div>
        </div>
    </div>

    <!-- Status Sections -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Phone Numbers Status -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Statut des numeros</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Disponibles</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-3">
                            <div class="bg-green-500 h-2 rounded-full" :style="'width: ' + stats.phones.availablePercent + '%'"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900" x-text="stats.phones.available"></span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Distribues</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-3">
                            <div class="bg-blue-500 h-2 rounded-full" :style="'width: ' + stats.phones.distributedPercent + '%'"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900" x-text="stats.phones.distributed"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Status -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Statut des contrats</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Valides</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-3">
                            <div class="bg-green-500 h-2 rounded-full" :style="'width: ' + stats.contracts.validatedPercent + '%'"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900" x-text="stats.contracts.validated"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="{% url 'dashboard:users' %}" class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow flex items-center">
            <div class="p-2 rounded-lg bg-blue-100 text-blue-600 mr-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </div>
            <span class="text-sm font-medium text-gray-700">Gerer les utilisateurs</span>
        </a>
        <a href="{% url 'dashboard:offers' %}" class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow flex items-center">
            <div class="p-2 rounded-lg bg-djezzy/10 text-djezzy mr-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
            </div>
            <span class="text-sm font-medium text-gray-700">Ajouter une offre</span>
        </a>
        <a href="{% url 'dashboard:phone_numbers' %}" class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow flex items-center">
            <div class="p-2 rounded-lg bg-green-100 text-green-600 mr-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
            </div>
            <span class="text-sm font-medium text-gray-700">Voir les numeros</span>
        </a>
        <a href="{% url 'dashboard:contracts' %}" class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow flex items-center">
            <div class="p-2 rounded-lg bg-purple-100 text-purple-600 mr-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <span class="text-sm font-medium text-gray-700">Voir les contrats</span>
        </a>
    </div>
</div>

{% else %}
<!-- ==================== AGENT COMMERCIAL DASHBOARD ==================== -->
<div x-data="agentDashboard()" x-init="init()">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- My Sales Card -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-djezzy/10 text-djezzy">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Mes Ventes</p>
                    <template x-if="loading">
                        <div class="h-8 w-16 bg-gray-200 rounded animate-pulse mt-1"></div>
                    </template>
                    <template x-if="!loading">
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.total"></p>
                    </template>
                </div>
            </div>
            <div class="mt-4 flex space-x-4 text-xs text-gray-500" x-show="!loading">
                <span class="flex items-center">
                    <span class="font-medium text-green-600" x-text="'+' + stats.today"></span>
                    <span class="ml-1">aujourd'hui</span>
                </span>
                <span class="flex items-center">
                    <span class="font-medium text-blue-600" x-text="stats.this_month"></span>
                    <span class="ml-1">ce mois</span>
                </span>
            </div>
        </div>

        <!-- Offers Card -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Offres</p>
                    <template x-if="loading">
                        <div class="h-8 w-16 bg-gray-200 rounded animate-pulse mt-1"></div>
                    </template>
                    <template x-if="!loading">
                        <p class="text-2xl font-bold text-gray-900" x-text="offersStats.total"></p>
                    </template>
                </div>
            </div>
            <div class="mt-4 flex space-x-4 text-xs text-gray-500" x-show="!loading">
                <span><span class="font-medium text-green-600" x-text="offersStats.active"></span> Actives</span>
            </div>
        </div>

        <!-- Phone Numbers Card -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Numeros</p>
                    <template x-if="loading">
                        <div class="h-8 w-16 bg-gray-200 rounded animate-pulse mt-1"></div>
                    </template>
                    <template x-if="!loading">
                        <p class="text-2xl font-bold text-gray-900" x-text="phonesStats.total"></p>
                    </template>
                </div>
            </div>
            <div class="mt-4 flex space-x-4 text-xs text-gray-500" x-show="!loading">
                <span><span class="font-medium text-green-600" x-text="phonesStats.available"></span> Disponibles</span>
                <span><span class="font-medium text-blue-600" x-text="phonesStats.distributed"></span> Distribues</span>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Sales Performance Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Ma Performance</h3>
            <p class="text-sm text-gray-500 mb-4">Ventes validees des 7 derniers jours</p>
            <div class="relative h-64">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Numbers Distribution Chart -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Numeros Disponibles</h3>
            <p class="text-sm text-gray-500 mb-4">Repartition des numeros</p>
            <div class="relative h-64 flex items-center justify-center">
                <canvas id="numbersChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Offers Chart -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Offres Vendues</h3>
        <p class="text-sm text-gray-500 mb-4">Vos meilleures ventes</p>
        <div class="relative h-64">
            <canvas id="topOffersChart"></canvas>
        </div>
        <template x-if="!loading && stats.by_offer.length === 0">
            <div class="absolute inset-0 flex items-center justify-center">
                <p class="text-gray-400">Aucune vente pour le moment</p>
            </div>
        </template>
    </div>

    <!-- Quick Links -->
    <div class="grid grid-cols-2 gap-4">
        <a href="{% url 'dashboard:phone_numbers' %}" class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow flex items-center">
            <div class="p-2 rounded-lg bg-green-100 text-green-600 mr-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
            </div>
            <span class="text-sm font-medium text-gray-700">Voir les numeros</span>
        </a>
        <a href="{% url 'dashboard:contracts' %}" class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-shadow flex items-center">
            <div class="p-2 rounded-lg bg-purple-100 text-purple-600 mr-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <span class="text-sm font-medium text-gray-700">Voir les contrats</span>
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
{% if user.role == 'admin' %}
// ==================== ADMIN DASHBOARD SCRIPT ====================
function adminDashboard() {
    return {
        loading: true,
        stats: {
            users: { total: 0, agents: 0, managers: 0 },
            offers: { total: 0, active: 0 },
            phones: { total: 0, available: 0, distributed: 0, availablePercent: 0, distributedPercent: 0 },
            contracts: { total: 0, validated: 0, validatedPercent: 0 }
        },

        async fetchStats() {
            this.loading = true;
            try {
                const [users, offers, phones, contractStats] = await Promise.all([
                    api.get('/user/'),
                    api.get('/offers/'),
                    api.get('/phone-numbers/'),
                    api.get('/contracts/stats/')
                ]);

                // Process users
                const userList = users.results || users;
                this.stats.users.total = userList.length;
                this.stats.users.agents = userList.filter(u => u.role === 'agent').length;
                this.stats.users.managers = userList.filter(u => u.role === 'manager').length;

                // Process offers
                const offerList = offers.results || offers;
                this.stats.offers.total = offerList.length;
                this.stats.offers.active = offerList.filter(o => o.is_active).length;

                // Process phones - only available and distributed (assigned = distributed)
                const phoneList = phones.results || phones;
                this.stats.phones.total = phoneList.length;
                this.stats.phones.available = phoneList.filter(p => p.status === 'available').length;
                this.stats.phones.distributed = phoneList.filter(p => p.status === 'assigned').length;

                // Calculate percentages
                if (this.stats.phones.total > 0) {
                    this.stats.phones.availablePercent = (this.stats.phones.available / this.stats.phones.total * 100).toFixed(0);
                    this.stats.phones.distributedPercent = (this.stats.phones.distributed / this.stats.phones.total * 100).toFixed(0);
                }

                // Process contracts - only validated
                this.stats.contracts.total = contractStats.total || 0;
                const byStatus = contractStats.by_status || {};
                this.stats.contracts.validated = byStatus.validated || 0;

                // Calculate contract percentage
                if (this.stats.contracts.total > 0) {
                    this.stats.contracts.validatedPercent = (this.stats.contracts.validated / this.stats.contracts.total * 100).toFixed(0);
                }

            } catch (error) {
                console.error('Error fetching stats:', error);
                showToast('Erreur lors du chargement des statistiques', 'error');
            }
            this.loading = false;
        }
    };
}
{% else %}
// ==================== AGENT COMMERCIAL DASHBOARD SCRIPT ====================
function agentDashboard() {
    return {
        loading: true,
        stats: {
            total: 0,
            today: 0,
            this_month: 0,
            revenue: 0,
            by_offer: [],
            daily_sales: []
        },
        offersStats: { total: 0, active: 0 },
        phonesStats: { total: 0, available: 0, distributed: 0 },
        salesChart: null,
        numbersChart: null,
        topOffersChart: null,

        async init() {
            this.loading = true;
            try {
                const [myStats, offers, phones] = await Promise.all([
                    api.get('/contracts/my-stats/'),
                    api.get('/offers/'),
                    api.get('/phone-numbers/')
                ]);

                // My stats
                this.stats.total = myStats.total || 0;
                this.stats.today = myStats.today || 0;
                this.stats.this_month = myStats.this_month || 0;
                this.stats.revenue = myStats.revenue || 0;
                this.stats.by_offer = myStats.by_offer || [];
                this.stats.daily_sales = myStats.daily_sales || [];

                // Offers
                const offerList = offers.results || offers;
                this.offersStats.total = offerList.length;
                this.offersStats.active = offerList.filter(o => o.is_active).length;

                // Phones - only available and distributed
                const phoneList = phones.results || phones;
                this.phonesStats.total = phoneList.length;
                this.phonesStats.available = phoneList.filter(p => p.status === 'available').length;
                this.phonesStats.distributed = phoneList.filter(p => p.status === 'assigned').length;

                this.loading = false;

                // Initialize charts after data is loaded
                this.$nextTick(() => {
                    this.initCharts();
                });

            } catch (error) {
                console.error('Error fetching stats:', error);
                showToast('Erreur lors du chargement des statistiques', 'error');
                this.loading = false;
            }
        },

        initCharts() {
            this.initSalesChart();
            this.initNumbersChart();
            this.initTopOffersChart();
        },

        initSalesChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            const labels = this.stats.daily_sales.map(d => d.date);
            const data = this.stats.daily_sales.map(d => d.count);

            this.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventes',
                        data: data,
                        borderColor: '#ED1C24',
                        backgroundColor: 'rgba(237, 28, 36, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ED1C24',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        },

        initNumbersChart() {
            const ctx = document.getElementById('numbersChart');
            if (!ctx) return;

            this.numbersChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Disponibles', 'Distribues'],
                    datasets: [{
                        data: [this.phonesStats.available, this.phonesStats.distributed],
                        backgroundColor: ['#10B981', '#3B82F6'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    }
                }
            });
        },

        initTopOffersChart() {
            const ctx = document.getElementById('topOffersChart');
            if (!ctx) return;

            const labels = this.stats.by_offer.map(o => o.name || 'N/A');
            const data = this.stats.by_offer.map(o => o.count);

            this.topOffersChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventes',
                        data: data,
                        backgroundColor: [
                            'rgba(237, 28, 36, 0.9)',
                            'rgba(237, 28, 36, 0.7)',
                            'rgba(237, 28, 36, 0.5)',
                            'rgba(237, 28, 36, 0.4)',
                            'rgba(237, 28, 36, 0.3)'
                        ],
                        borderRadius: 8,
                        barThickness: 30
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
    };
}
{% endif %}
</script>
{% endblock %}
